---
title: "Power Analysis"
author: "Simone D'Ambrogio"
subtitle: "Replication Study JDMLab"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    highlight: tango
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, fig.align='center')
library(knitr)
## Global options
options(max.print="75")
opts_chunk$set(
	             cache=TRUE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE
               )
opts_knit$set(width=75)
```

<style type="text/css">
body {
text-align: justify;
font-size: 16px;
}

.center {
  display: block;
  margin-left: auto;
  margin-right: auto;
  width: 50%;
}



</style>
<br><br>
<font size="6"> **Introduction** </font>
<br>
One of the most difficult and important decisions in power analysis involves specifying an effect size. Here we use previous finding to quantify the sample size needed to have a 80% statistical power, assuming as effect equal to the one these papers report.

<br><br>
<font size="4"> **Thaler, R. (1985). Mental accounting and consumer choice. Marketing science, 4(3), 199-214.** </font>

<br><br><br>
<font size="3"> **Scenario 1** </font>

<br>
First, generate data assuming a multinomial distribution.
The outcomes will be determined by a vector  θ (called true_theta
 below in the R code) that indicates the probability of each outcome:
 
 <br>
```{r message=F}
 #Load libraries:
library(brms); library(dplyr); library(purrr)
library(ggplot2); theme_set(ggpubr::theme_pubr())
library(gridExtra)
library(extraDistr) # This library contains multinomial distribution
```

```{r message=F, warning=F, fig.width=3, fig.height=4}
N_sbj <- 87
answers <- c('A'=56, 'B'=16, 'nd'=15)

(true_theta <- data.frame(A  = answers['A']/N_sbj, 
                          B  = answers['B']/N_sbj, 
                          nd = answers['nd']/N_sbj, 
                          row.names = 'Proportion of Responses'))
```
<br><br>
Given this vector of probabilities θ, generate values assuming a 
multinomial distribution of responses in 100 trials:

```{r message=F, warning=F, fig.width=3, fig.height=4}
N <- N_sbj
(sim_ans <- rmultinom(1, N_sbj, true_theta))
```

<br><br>
Now, let's fit this simulated data using Stan. 
<br>
Stan Code:
```{r eval = FALSE}
data {
  int<lower = 1> N_sbj;
  int<lower = 0,upper = N_trials> ans[3];
}
parameters {
  simplex[3] theta;
}
model {
  target += dirichlet_lpdf(theta | rep_vector(2, 3));
  target += multinomial_lpmf(ans | theta);
}
```

<br>
Stan Data:
```{r message=F, warning=F, fig.width=3, fig.height=4}
stan_data <-  list(N_sbj = N_sbj,
                   ans = c(sim_ans)) 
```

<br>
Fit Stan Model:
```{r message=F, warning=F, fig.width=3, fig.height=4}
library( rstan ); options( mc.cores = 4 ); 
rstan_options(auto_write = TRUE)

# Upload Stancode:
stan_model <- stan_model(file = "Stan/mulinomial.stan")
# Fit model
res<-sampling(stan_model, iter = 2000, cores=4, 
              data=stan_data, save_warmup = FALSE)

plot(res)
```

Repeat this procedure and count the number of time the 95% Credible Interval (CI) of response 'A' intersects the 95% CI of response 'B'.

```{r}
sim_power <- function(true_theta, N_sbj){
  # Generate Artificial Data
  N <- N_sbj
  (sim_ans <- rmultinom(1, N_sbj, true_theta))
  # Fit Model
  stan_data <-  list(N_sbj = N_sbj, ans = c(sim_ans)) 
  res<-sampling(stan_model, iter = 2000, cores=4, 
              data=stan_data, save_warmup = FALSE)
}


```

```{r}

```

<font size="4"> **Estimates of EEM** </font>
